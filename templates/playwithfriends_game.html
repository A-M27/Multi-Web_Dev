{% extends "base.html" %}
{% block title %}Play with Friends (Game: {{ game_id }}){% endblock %}

{% block content %}
<main>
    <div class="live-layout-container">
        {% if current_user %}
        
            <div class="main-content-column">
                
                <h2 id="game-status-header">Welcome, {{ current_user.username }}! Game ID: {{ game_id }}</h2>

                <div class="card-interface">
                    <div id="card-display-area" style="padding: 20px; width: 100%;">
                        <div id="card-content-container" style="font-weight: bold; min-height: 50px; text-align: center;">
                            <div id="card-front-text">
                                {% if card %}
                                    {{ card.front }}
                                {% else %}
                                    Waiting for the game creator to start...
                                {% endif %}
                            </div>
                            <div id="card-back-text" style="display: none;">
                                {% if card %}
                                    {{ card.back }}
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="button-controls">
                        <button class="btn" id="showAnswerBtn" style="display: none;">Answer</button>
                        {% if is_creator %}
                            <button class="btn" id="gameControlButton">
                                {% if game.status == 'LOBBY' %}
                                    Start Game
                                {% else %}
                                    Post Next Question
                                {% endif %}
                            </button>
                        {% endif %}
                    </div>
                </div>

            </div>

            <div class="live-chat-sidebar">
                
                <div class="scoring-header-area">
                    <div class="score-pills-container">
                        <div class="score-pill correct-pill">
                            <span class="pill-label">‚úÖ Correct: <span id="user-score-correct">0.0</span></span>
                            <div id="initials-correct" class="initials-area"></div>
                        </div>
                        <div class="score-pill half-correct-pill">
                            <span class="pill-label">üü° Half-Correct: <span id="user-score-half">0.0</span></span>
                            <div id="initials-half" class="initials-area"></div>
                        </div>
                        <div class="score-pill wrong-pill">
                            <span class="pill-label">‚ùå Wrong: <span id="user-score-wrong">0</span></span>
                            <div id="initials-wrong" class="initials-area"></div>
                        </div>
                    </div>
                </div>

                <div class="chat-mode-selector" id="chat-mode-selector">
                    <button id="mode-answer" class="active">Chat Answer</button>
                    <button id="mode-friends">Chat with Friends</button>
                    <button id="mode-leaderboard">Leaderboard</button> 
                </div>
                
                <div id="sidebar-content-wrapper" style="display: flex; flex-direction: column; flex-grow: 1;">
                    
                    <div id="chat-view" style="display: flex; flex-direction: column; flex-grow: 1;">
                        
                        <div class="chat-messages" id="chat-messages-container" style="flex-grow: 1;">
                            
                            <div id="chat-history-answer" class="chat-history active">
                                <ul></ul>
                            </div>
                            
                            <div id="chat-history-friends" class="chat-history">
                                <ul></ul>
                            </div>
                        </div>
                    </div>

                    <div id="leaderboard-view" class="leaderboard-history" style="display: none; flex-grow: 1; overflow-y: auto; padding: 10px;">
                        <div style="font-size: 1.2em; text-align: center; padding-bottom: 10px; border-bottom: 1px solid #ddd; margin-bottom: 10px; font-weight: bold;">
                            Global Leaderboard
                        </div>
                        <ul id="leaderboard-list" class="leaderboard-list" style="list-style: none; padding: 0;">
                            </ul>
                    </div>
                    
                </div>
                
                <div id="chat-input-wrapper" class="chat-input-wrapper">
                    <div class="chat-input-area">
                        <form id="chat-form" action="">
                            <input type="text" id="messageText" autocomplete="off" placeholder="Type your answer or message..." />
                            <button id="send-button" type="submit">Send</button>
                        </form>
                    </div>
                </div>
                
            </div>

        {% else %}
            <div class="main-content-column">
                <h2>Access Denied (403)</h2>
                <p>You must be logged in to access this page. Please <a href="/users/login">login</a> or <a href="/users/register">register</a>.</p>
            </div>
        {% endif %} 
    </div>
</main>

<script>
    {% if current_user %}
    const userName = "{{ current_user.username }}";
    const gameId = "{{ game_id }}";
    const isCreator = {{ "true" if is_creator else "false" }};
    const ws = new WebSocket(`ws://{{ request.url.netloc }}/games/ws/${gameId}/${userName}`);

    // --- DOM Elements ---
    const messageInput = document.getElementById('messageText');
    const chatForm = document.getElementById('chat-form');
    const showAnswerBtn = document.getElementById('showAnswerBtn');
    const gameControlButton = document.getElementById('gameControlButton');
    const cardContentContainer = document.getElementById('card-content-container');
    const cardFrontText = document.getElementById('card-front-text');
    const cardBackText = document.getElementById('card-back-text');
    const cardDisplayArea = document.querySelector('.card-interface');
    const chatInputWrapper = document.getElementById('chat-input-wrapper');
    const leaderboardList = document.getElementById('leaderboard-list');
    const gameStatusHeader = document.getElementById('game-status-header');
    
    // View/Mode elements
    const chatView = document.getElementById('chat-view');
    const leaderboardView = document.getElementById('leaderboard-view');

    // Chat mode buttons/histories
    const modeAnswerBtn = document.getElementById('mode-answer');
    const modeFriendsBtn = document.getElementById('mode-friends');
    const modeLeaderboardBtn = document.getElementById('mode-leaderboard'); 
    const historyAnswer = document.getElementById('chat-history-answer');
    const historyFriends = document.getElementById('chat-history-friends');
    
    // Scoreboard elements
    const scoreCorrect = document.getElementById('user-score-correct');
    const scoreHalf = document.getElementById('user-score-half');
    const scoreWrong = document.getElementById('user-score-wrong');
    const initialsCorrect = document.getElementById('initials-correct');
    const initialsHalf = document.getElementById('initials-half');
    const initialsWrong = document.getElementById('initials-wrong');

    // --- State Variables ---
    let currentCardData = {
        front: cardFrontText ? cardFrontText.textContent.trim() : '',
        back: cardBackText ? cardBackText.textContent.trim() : ''
    };
    let isFlipped = false;
    let hasAnsweredCurrentCard = false; 
    let currentChatMode = 'answer'; 
    let currentSidebarView = 'chat'; 
    let currentGameState = "{{ game.status }}"; // LOBBY, ACTIVE, FINISHED
    let currentQuestionNumber = {{ game.current_question_count }};
    let maxQuestions = {{ game.max_questions }};

    if(cardContentContainer) cardContentContainer.style.fontSize = '1.5em';

    // Helper functions (omitted for brevity, assume they are the same as the final version you accepted, including appendChatMessage, createInitialsIcon, resetScoreboardInitials, updateScoreboardPills, and renderLeaderboard)
    function appendChatMessage(sender, text, mode) {
        let historyContainer = (mode === 'answer') ? historyAnswer : historyFriends;
        let messageList = historyContainer.querySelector('ul');
        if (!messageList) {
            messageList = document.createElement('ul');
            historyContainer.appendChild(messageList);
        }
        
        const li = document.createElement('li');
        const usernameSpan = document.createElement('span');
        usernameSpan.className = 'username';
        usernameSpan.textContent = sender + ':';
        li.appendChild(usernameSpan);
        
        text.split('\n').forEach(line => {
            li.appendChild(document.createTextNode(' ' + line));
            li.appendChild(document.createElement('br'));
        });
        
        if (li.lastChild && li.lastChild.tagName === 'BR') {
            li.removeChild(li.lastChild);
        }
        
        messageList.appendChild(li);
        
        if (currentSidebarView === 'chat' && historyContainer.classList.contains('active')) {
            historyContainer.scrollTop = historyContainer.scrollHeight;
        }
    }
    
    function initializeChatHistory() {
        if (historyAnswer.querySelector('ul').children.length === 0) {
            appendChatMessage("Grader", "Game Status: " + currentGameState, 'answer');
        }
        if (historyFriends.querySelector('ul').children.length === 0) {
            appendChatMessage("Friends", "Quick chat messages appear here.", 'friends');
        }
    }

    function createInitialsIcon(initials) {
        const icon = document.createElement('span');
        icon.className = 'profile-icon';
        icon.textContent = initials;
        return icon;
    }

    function resetScoreboardInitials() {
        initialsCorrect.innerHTML = '';
        initialsHalf.innerHTML = '';
        initialsWrong.innerHTML = '';
    }

    function updateScoreboardPills(scores, senderUsername, result) {
        if (result !== 'none') {
            const initials = senderUsername.charAt(0).toUpperCase();
            let targetDiv;
            if (result === 'correct') {
                targetDiv = initialsCorrect;
            } else if (result === 'half') {
                targetDiv = initialsHalf;
            } else { 
                targetDiv = initialsWrong;
            }
            
            if (!targetDiv.querySelector(`[data-username="${senderUsername}"]`)) {
                 const icon = createInitialsIcon(initials);
                 icon.setAttribute('data-username', senderUsername); 
                 targetDiv.appendChild(icon);
            }
        }
        
        const userScore = scores[userName];
        if (userScore) {
            scoreCorrect.textContent = (userScore.correct * 5).toFixed(1); 
            scoreHalf.textContent = (userScore.half * 2.5).toFixed(1); 
            scoreWrong.textContent = userScore.wrong; 
        }
    }
    
    function renderLeaderboard(scores) {
        leaderboardList.innerHTML = '';

        const sortedScores = Object.entries(scores)
            .map(([username, data]) => ({ 
                username, 
                grade: data.grade || 0
            }))
            .sort((a, b) => b.grade - a.grade);

        sortedScores.forEach((item, index) => {
            const li = document.createElement('li');
            li.style.padding = '8px 0';
            li.style.borderBottom = '1px dotted #eee';
            const rank = index + 1;
            const rankSpan = `<span class="rank" style="font-weight: bold; width: 30px; display: inline-block;">${rank}.</span>`;
            const nameSpan = `<span style="${item.username === userName ? 'color: #007bff; font-weight: bold;' : ''}">${item.username}</span>`;
            const scoreSpan = `<span style="float: right; font-weight: bold;">${item.grade.toFixed(1)} pts</span>`;
            
            li.innerHTML = rankSpan + nameSpan + scoreSpan;
            
            leaderboardList.appendChild(li);
        });

        setSidebarView('leaderboard'); 
    }
    
    function setChatMode(mode) {
        currentChatMode = mode;
        modeAnswerBtn.classList.remove('active');
        modeFriendsBtn.classList.remove('active');
        modeLeaderboardBtn.classList.remove('active');
        historyAnswer.classList.remove('active');
        historyFriends.classList.remove('active');

        if (mode === 'answer') {
            modeAnswerBtn.classList.add('active');
            historyAnswer.classList.add('active');
            messageInput.placeholder = "Type your answer here...";
            historyAnswer.scrollTop = historyAnswer.scrollHeight;
        } else {
            modeFriendsBtn.classList.add('active');
            historyFriends.classList.add('active');
            messageInput.placeholder = "Chat with friends...";
            historyFriends.scrollTop = historyFriends.scrollHeight;
        }
        setSidebarView('chat'); 
    }

    function setSidebarView(view) {
        currentSidebarView = view;

        if (view === 'chat') {
            chatView.style.display = 'flex';
            leaderboardView.style.display = 'none';
            chatInputWrapper.style.display = 'block'; 
            
            if (currentChatMode === 'answer') {
                modeAnswerBtn.classList.add('active');
            } else {
                modeFriendsBtn.classList.add('active');
            }
            modeLeaderboardBtn.classList.remove('active');

        } else if (view === 'leaderboard') {
            chatView.style.display = 'none';
            leaderboardView.style.display = 'block';
            chatInputWrapper.style.display = 'none'; 
            
            modeAnswerBtn.classList.remove('active');
            modeFriendsBtn.classList.remove('active');
            modeLeaderboardBtn.classList.add('active'); 
            
            leaderboardView.scrollTop = 0;
        }
    }
    
    function updateGameDisplay() {
        if (currentGameState === 'LOBBY') {
            gameStatusHeader.textContent = `Waiting for game to start... Game ID: ${gameId}`;
            cardFrontText.textContent = "Waiting for the game creator to start...";
            cardBackText.textContent = "";
            showAnswerBtn.style.display = 'none';
            if (isCreator) {
                gameControlButton.textContent = "Start Game";
                gameControlButton.disabled = false;
            }
            // Clear past question state
            hasAnsweredCurrentCard = false; 
            resetScoreboardInitials();
        } else if (currentGameState === 'ACTIVE') {
            gameStatusHeader.textContent = `Question ${currentQuestionNumber}/${maxQuestions} | Game ID: ${gameId}`;
            showAnswerBtn.style.display = 'inline-block';
            if (isCreator) {
                gameControlButton.textContent = "Post Next Question";
                gameControlButton.disabled = false;
            } else {
                gameControlButton.style.display = 'none';
            }
        } else if (currentGameState === 'FINISHED') {
            gameStatusHeader.textContent = `Game Over! Final Scores (Game ID: ${gameId})`;
            cardFrontText.textContent = "The game has finished. Check the Leaderboard for final results.";
            cardBackText.textContent = "";
            showAnswerBtn.style.display = 'none';
            if (isCreator) {
                gameControlButton.textContent = "Game Finished";
                gameControlButton.disabled = true;
            }
            // Automatically switch to leaderboard on finish
            modeLeaderboardBtn.click();
        }
    }
    
    // Initial display setup
    document.addEventListener('DOMContentLoaded', () => {
        updateGameDisplay();
    });

    // --- Event Listeners ---
    modeAnswerBtn.addEventListener('click', () => setChatMode('answer'));
    modeFriendsBtn.addEventListener('click', () => setChatMode('friends'));
    
    modeLeaderboardBtn.addEventListener('click', function() {
        if (currentSidebarView === 'leaderboard') {
            setSidebarView('chat'); 
        } else {
            setSidebarView('leaderboard'); 
            ws.send(JSON.stringify({ type: 'score_request' }));
        }
    });

    if (gameControlButton) {
        gameControlButton.addEventListener('click', function() {
            if (currentGameState === 'LOBBY') {
                ws.send(JSON.stringify({ type: "game_control", payload: { command: "start_game" } }));
            } else if (currentGameState === 'ACTIVE') {
                ws.send(JSON.stringify({ type: "game_control", payload: { command: "request_next_card" } }));
            }
        });
    }

    // --- WebSocket Event Handlers ---
    ws.onmessage = function(event) {
        let data;
        try {
            data = JSON.parse(event.data);
        } catch (e) {
            console.error("Failed to parse incoming WebSocket message:", event.data, e);
            return;
        }
        
        if (data.type === 'chat_message') {
            appendChatMessage(data.sender, data.text, data.mode);
            
        } else if (data.type === 'game_status_update') {
            currentGameState = data.status;
            appendChatMessage("SYSTEM", data.message, 'friends');
            updateGameDisplay();

        } else if (data.type === 'new_card') {
            currentGameState = 'ACTIVE';
            currentCardData.front = data.front;
            currentCardData.back = data.back;
            isFlipped = false;
            hasAnsweredCurrentCard = false; 
            currentQuestionNumber = data.question_number;
            maxQuestions = data.max_questions;
            
            cardFrontText.textContent = data.front; 
            cardBackText.textContent = data.back;
            cardContentContainer.style.fontSize = '1.5em'; 
            showAnswerBtn.textContent = 'Answer';
            
            messageInput.value = '';
            
            resetScoreboardInitials(); 
            setSidebarView('chat'); 
            updateGameDisplay();

            cardDisplayArea.style.backgroundColor = '#f0fff0'; 
            setTimeout(() => { cardDisplayArea.style.backgroundColor = ''; }, 300);
            
        } else if (data.type === 'answer_result') {
            const sender = data.sender;
            const result = data.result;
            
            appendChatMessage(sender, `answered: "${data.answer}". Result: ${result.toUpperCase()}`, 'answer');
            updateScoreboardPills(data.scores, sender, result);

            if (sender === userName) {
                hasAnsweredCurrentCard = true;
                if (currentChatMode === 'answer') {
                    messageInput.value = '';
                }
            }

        } else if (data.type === 'score_update') {
            const scores = data.scores;
            
            updateScoreboardPills(scores, userName, 'none'); 
            if (currentSidebarView === 'leaderboard') { 
                 renderLeaderboard(scores);
            }
        }
    };
    
    ws.onopen = function(event) {
        initializeChatHistory();
        setSidebarView('chat');
        ws.send(JSON.stringify({ type: 'score_request' }));
    };

    ws.onclose = function(event) {
        console.log("WebSocket connection closed.");
    };

    ws.onerror = function(error) {
        console.error("WebSocket error:", error);
    };


    // --- Form Submission (Unified Chat/Answer) ---
    chatForm.addEventListener('submit', async function(event) {
        event.preventDefault();
        const message = messageInput.value.trim();
        if (!message || currentSidebarView === 'leaderboard') return;

        if (currentChatMode === 'answer') {
            if (currentGameState !== 'ACTIVE') {
                 appendChatMessage("INFO", "The game is not currently accepting answers.", 'answer');
                 messageInput.value = '';
                 return;
            }
            if (hasAnsweredCurrentCard) {
                appendChatMessage("INFO", "You have already submitted an answer for this question.", 'answer');
                messageInput.value = '';
                return;
            }
            
            const data = { type: "answer_submission", payload: { answer: message } };
            ws.send(JSON.stringify(data));
            
        } else { // currentChatMode === 'friends'
            const data = { type: "chat", payload: { message: message, mode: 'friends' } };
            ws.send(JSON.stringify(data));
            messageInput.value = ''; 
        }
    });

    // 3. Show Answer Button (Flip Logic)
    showAnswerBtn.addEventListener('click', function() {
        // ... (Flip logic as before)
         if (!currentCardData.front) {
             console.log("No card loaded.");
             return;
         }
        
         if (!isFlipped) {
             cardFrontText.textContent = currentCardData.back;
             cardContentContainer.style.fontSize = '1.2em';
             showAnswerBtn.textContent = 'Back to Question';
             isFlipped = true;
         } else {
             cardFrontText.textContent = currentCardData.front;
             cardContentContainer.style.fontSize = '1.5em';
             showAnswerBtn.textContent = 'Answer';
             isFlipped = false;
         }
    });

    {% endif %}
</script>
{% endblock %}
