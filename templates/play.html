{% extends "base.html" %}
{% block title %}Personal Trivia{% endblock %}

{% block head %}
    {{ super() }}
{% endblock %}

{% block content %}
<main>
    <div class="personal-layout-container" style="max-width: 800px; margin: 0 auto; padding: 20px;">
        {# Check 1: User Logged In #}
        {% if current_user %}
        
            {# --- State 1: Initial Select (Setup Game) --- #}
            {% if game_state == "initial_select" %}
                <div class="main-content-column" style="text-align: center;">
                    <h2>Set Up Your Personal Trivia Game</h2>
                    
                    <div style="padding: 20px; background: #e9ecef; border-radius: 8px; max-width: 500px; margin: 20px auto;">
                        <h3>Choose Your Game Settings</h3>
                        <form id="setup-form" action="/cards/playtriv/start" method="POST" class="form">
                            <div class="form-group">
                                <label for="set_id">Select Card Set (Trivia Subject):</label>
                                <select id="set_id" name="set_id" required>
                                    {% for set in sets %}
                                        <option value="{{ set.id }}">{{ set.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="num_questions">Number of Questions (Max: 50):</label>
                                <input type="number" id="num_questions" name="num_questions" value="10" min="1" max="50" required>
                            </div>
                            <button type="submit" class="btn" style="background: #28a745; color: white;">‚ñ∂Ô∏è Start Solo Game</button>
                        </form>
                    </div>
                </div>

            {# --- State 2: Game In Progress (Live Interface) --- #}
            {% elif game_state == "in_progress" %}
                <div class="main-content-column" style="padding: 0;">
                    
                    <h2 style="text-align: center;">Personal Trivia: {{ set_name }}</h2>
                    <p style="text-align: center; color: #666; margin-bottom: 20px;">Question <span id="question-number">{{ card_index + 1 }}</span> of {{ total_questions }}</p>

                    <div class="card-interface">
                        <div id="card-display-area" style="padding: 20px; width: 100%;">
                            <div id="card-content-container" style="font-weight: bold; min-height: 50px;">
                                {% if card %}
                                    <div id="card-front-text">{{ card.front }}</div>
                                    <div id="card-back-text" style="display: none;">{{ card.back }}</div>
                                {% else %}
                                    <div id="card-front-text">Loading first question...</div>
                                    <div id="card-back-text" style="display: none;"></div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="button-controls" style="justify-content: center; gap: 20px;">
                            <button class="btn" id="showAnswerBtn">Show Answer</button>
                            <button class="btn" id="nextCardBtn" disabled>Next Question</button>
                        </div>
                    </div>
                    
                    {# --- ANSWER INPUT AREA --- #}
                    <div id="answer-area" style="margin-top: 20px; padding: 20px; border: 1px solid #ddd; border-radius: 8px; background: #f9f9f9;">
                        <h3>Your Answer:</h3>
                        <form id="answer-form">
                            <div class="form-group" style="margin-bottom: 10px; background: none;">
                                <textarea id="user-answer" rows="2" placeholder="Type your answer here..." style="width: 100%; padding: 10px;"></textarea>
                            </div>
                            <button type="submit" class="btn" id="submitAnswerBtn" style="background: #007bff; color: white; margin-top: 10px;">Submit Answer</button>
                            <span id="feedback-message" style="margin-left: 20px; font-weight: bold;"></span>
                        </form>
                    </div>
                    {# --- END ANSWER INPUT AREA --- #}


                    <div style="text-align: center; margin-top: 30px;">
                         <a href="/cards/playtriv" class="btn btn-danger" id="endGameBtn" style="background: #dc3545;">üõë End Current Game</a>
                    </div>
                </div>

            {# --- State 3: Game Finished --- #}
            {% elif game_state == "finished" %}
                 <div class="main-content-column" style="text-align: center;">
                    <h2>Game Over: {{ set_name }}</h2>
                    <h3>Final Score: <span style="color: #28a745;">{{ final_score | default(0) | round(1) }}</span> points out of a maximum of <span style="color: #007bff;">{{ (total_questions * 5) | round(1) }}</span>!</h3>
                    <p>You completed all {{ total_questions }} questions.</p>
                    <div style="margin-top: 30px;">
                        <a href="/cards/playtriv" class="btn" style="background: #28a745; color: white;">Start a New Game</a>
                        <a href="/" class="btn" style="background: #007bff; color: white;">Go Home</a>
                    </div>
                </div>
            
            {# --- State 4: Game Not Found/Error --- #}
            {% else %}
                 <div class="main-content-column" style="text-align: center;">
                    <h2>Error</h2>
                    <p>An unexpected state occurred. Please <a href="/cards/playtriv">start a new game</a>.</p>
                </div>
            {% endif %}

        {% else %}
            {# Check 1 Else: Not Logged In #}
            <div class="main-content-column" style="text-align: center;">
                <h2>Access Denied (403)</h2>
                <p>You must be logged in to access this page. Please <a href="/users/login">login</a> or <a href="/users/register">register</a>.</p>
            </div>
        {% endif %} 
    </div>
</main>

<script>
    {% if current_user and game_state == "in_progress" %}
    const questionNumberSpan = document.getElementById('question-number');
    const showAnswerBtn = document.getElementById('showAnswerBtn');
    const nextCardBtn = document.getElementById('nextCardBtn');
    const endGameBtn = document.getElementById('endGameBtn');
    const cardContentContainer = document.getElementById('card-content-container');
    const cardFrontText = document.getElementById('card-front-text');
    const cardBackText = document.getElementById('card-back-text');
    const answerForm = document.getElementById('answer-form');
    const userAnswerInput = document.getElementById('user-answer');
    const submitAnswerBtn = document.getElementById('submitAnswerBtn');
    const feedbackMessage = document.getElementById('feedback-message');


    // Initial state variables loaded from Jinja context
    let currentCardIndex = {{ card_index }};
    const totalQuestions = {{ total_questions }};
    const gameId = "{{ game_id }}";
    let isAnswered = false; 
    let submittedResult = null;
    let correctCardAnswer = cardBackText ? cardBackText.textContent.trim() : '';
    
    let currentCardData = {
        front: cardFrontText ? cardFrontText.textContent.trim() : '',
        back: correctCardAnswer
    };
    let isFlipped = false;

    // Initially disable Next button until an answer is submitted/shown
    nextCardBtn.disabled = true;


    // --- Helper function to reset for new question ---
    function resetCardState() {
        isAnswered = false;
        isFlipped = false;
        submittedResult = null;
        correctCardAnswer = currentCardData.back;
        
        showAnswerBtn.disabled = false;
        showAnswerBtn.textContent = 'Show Answer';
        nextCardBtn.disabled = true;
        
        submitAnswerBtn.disabled = false;
        submitAnswerBtn.textContent = 'Submit Answer';
        userAnswerInput.value = '';
        userAnswerInput.disabled = false;
        
        feedbackMessage.textContent = '';
        cardContentContainer.style.backgroundColor = 'transparent';
        cardFrontText.textContent = currentCardData.front; // Ensure card is flipped back
        cardContentContainer.style.fontSize = '1.5em';
    }


    // --- Card Flip Logic ---
    showAnswerBtn.addEventListener('click', function() {
        if (!currentCardData.front) return;
        
        if (!isFlipped) {
            const answerToShow = correctCardAnswer || currentCardData.back;

            cardFrontText.textContent = answerToShow;
            cardContentContainer.style.fontSize = '1.2em';
            showAnswerBtn.textContent = 'Back to Question';
            isFlipped = true;
            
            if (!isAnswered) {
                userAnswerInput.disabled = true;
                submitAnswerBtn.disabled = true;
                nextCardBtn.disabled = false;
                feedbackMessage.textContent = 'Answer shown (No score recorded).';
                feedbackMessage.style.color = 'orange';
            }

        } else {
            cardFrontText.textContent = currentCardData.front;
            cardContentContainer.style.fontSize = '1.5em';
            showAnswerBtn.textContent = 'Show Answer';
            isFlipped = false;
        }
    });

    // --- Answer Submission Logic (FIXED: Handles server errors & displays correct answer) ---
    answerForm.addEventListener('submit', async function(event) {
        event.preventDefault();
        // FIX: Check if the button is disabled to prevent rapid clicks/re-submission
        if (submitAnswerBtn.disabled || isAnswered || userAnswerInput.disabled) return;
        
        const answer = userAnswerInput.value.trim();
        if (!answer) return;

        // Temporarily disable buttons before the fetch begins
        submitAnswerBtn.disabled = true;
        submitAnswerBtn.textContent = 'Checking...';
        showAnswerBtn.disabled = true;

        try {
            const response = await fetch('/cards/playtriv/answer', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ game_id: gameId, answer: answer })
            });

            const data = await response.json();

            if (data.status === 'error') {
                
                // FIX: Check for "not in progress" error and force redirect
                if (data.message.includes('not in progress') || response.status === 404 || response.status === 500) {
                    alert("Game session invalid or finished. Please start a new game.");
                    // Use a full redirect to clear any residual state
                    window.location.href = '/cards/playtriv'; 
                    return; 
                }
                
                // Re-enable buttons on other errors
                feedbackMessage.textContent = data.message;
                feedbackMessage.style.color = 'red';
                submitAnswerBtn.textContent = 'Submit Answer';
                submitAnswerBtn.disabled = false;
                showAnswerBtn.disabled = false;
                return;
            }
            
            // Store results from server
            isAnswered = true;
            submittedResult = data.result;
            correctCardAnswer = data.correct_answer;
            
            // Update UI/State
            // FIX: Only enable the Next Card button if we're NOT on the last question
            if (currentCardIndex < totalQuestions - 1) {
                nextCardBtn.disabled = false;
            } else {
                // If it's the last question, we still want to enable "Next" to trigger the finish logic
                nextCardBtn.disabled = false;
                nextCardBtn.textContent = 'Finish Game';
            }

            userAnswerInput.disabled = true;
            submitAnswerBtn.textContent = 'Submitted';
            showAnswerBtn.disabled = false;

            let result = submittedResult.toUpperCase();
            
            if (result === 'CORRECT') {
                feedbackMessage.textContent = `Result: CORRECT! (+5 points)`;
                feedbackMessage.style.color = 'green';
                cardContentContainer.style.backgroundColor = '#e6ffe6';
            } else if (result === 'HALF') {
                feedbackMessage.textContent = `Result: HALF-CORRECT! (+2.5 points) Correct answer: ${correctCardAnswer}`;
                feedbackMessage.style.color = 'orange';
                cardContentContainer.style.backgroundColor = '#fffbe6';
            } else { // WRONG
                feedbackMessage.textContent = `Result: WRONG! (0 points) The correct answer was: ${correctCardAnswer}`;
                feedbackMessage.style.color = 'red';
                cardContentContainer.style.backgroundColor = '#ffe6e6';
            }


        } catch (error) {
            console.error('Network error during answer submission:', error);
            feedbackMessage.textContent = 'Network error.';
            feedbackMessage.style.color = 'red';
            submitAnswerBtn.textContent = 'Submit Answer';
            submitAnswerBtn.disabled = false;
            showAnswerBtn.disabled = false;
        }
    });

    
    // --- Next Card Logic ---
    nextCardBtn.addEventListener('click', async function() {
        if (nextCardBtn.disabled) return;
        
        nextCardBtn.disabled = true;
        nextCardBtn.textContent = 'Loading...';
        showAnswerBtn.disabled = true;
        
        try {
            const response = await fetch('/cards/playtriv/next', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ game_id: gameId, current_index: currentCardIndex })
            });

            const data = await response.json();

            if (data.status === 'finished') {
                window.location.href = `/cards/playtriv?status=finished&game_id=${gameId}`;
                return;
            } else if (data.status === 'success' && data.card) {
                // Update Card Data
                currentCardIndex = data.card_index;
                currentCardData.front = data.card.front;
                currentCardData.back = data.card.back;
                
                cardFrontText.textContent = currentCardData.front; 
                cardBackText.textContent = data.card.back;
                cardContentContainer.style.fontSize = '1.5em'; 
                
                // Update question counter and reset state
                questionNumberSpan.textContent = currentCardIndex + 1;
                resetCardState();

            } else {
                console.error("Error fetching next card:", data.message || data);
                alert("Failed to load the next question.");
            }
        } catch (error) {
            console.error('Network error during next card fetch:', error);
            alert('A network error occurred.');
        } finally {
            // Re-enable in case of an error that didn't trigger a redirect
            if (currentCardIndex < totalQuestions - 1) {
                 nextCardBtn.textContent = 'Next Question';
            }
        }
    });

    // End Game Button (REMAINS THE SAME)
    endGameBtn.addEventListener('click', function(event) {
        if (confirm('Are you sure you want to end this personal trivia game? You will return to the setup screen.')) {
            // No need to call a POST endpoint, just clear the game on the client side 
            // and the server will eventually time it out/clean it up. 
            // The redirection is enough to "end" the user's session.
            window.location.href = '/cards/playtriv';
        }
        event.preventDefault();
    });

    {% elif game_state == "finished" %}
        // Final score logic is now handled in the Jinja template using passed context
    {% endif %}
</script>
{% endblock %}
