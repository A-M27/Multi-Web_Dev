{% extends "base.html" %}
{% block title %}Play with Friends (Live){% endblock %}

{% block head %}
    {{ super() }}
{% endblock %}

{% block content %}
<main>
    <div class="live-layout-container">
        {# Check 1: User Logged In #}
        {% if current_user %}
        
            {# Check 2: Transitional States #}

            {# --- State 1: Game Not Found --- #}
            {% if game_state == "not_found" %}
                <div class="main-content-column" style="text-align: center;">
                    <h2>Game Not Found üòî</h2>
                    <p>The game ID **{{ game_id }}** does not exist or is no longer active.</p>
                    <p>Please <a href="/cards/playwithfriends" class="btn">Create or Join a New Game</a>.</p>
                </div>
            
            {# --- State 2: Initial Select (Create or Join) --- #}
            {% elif game_state == "initial_select" %}
                <div class="main-content-column" style="display: flex; flex-direction: column; gap: 2rem; max-width: 800px; margin: 0 auto;">
                    <h2>Play with Friends</h2>
                    <div style="display: flex; gap: 2rem;">
                        <div style="flex: 1; padding: 20px; background: #e9ecef; border-radius: 8px;">
                            <h3>Create a New Game (Host)</h3>
                            <form action="/cards/playwithfriends/create" method="POST" class="form">
                                <div class="form-group">
                                    <label for="set_id">Select Card Set (Game Type):</label>
                                    <select id="set_id" name="set_id" required>
                                        {% for set in sets %}
                                            <option value="{{ set.id }}">{{ set.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="num_questions">Number of Questions (Max: 50):</label>
                                    <input type="number" id="num_questions" name="num_questions" value="10" min="1" max="50" required>
                                </div>
                                <button type="submit" class="btn" style="background: #28a745; color: white;">üöÄ Create Game</button>
                            </form>
                        </div>

                        <div style="flex: 1; padding: 20px; background: #e9ecef; border-radius: 8px;">
                            <h3>Join an Existing Game</h3>
                            <form action="/cards/playwithfriends/join" method="POST" class="form">
                                <div class="form-group">
                                    <label for="game_id_join">Enter Game ID:</label>
                                    <input type="text" id="game_id_join" name="game_id" placeholder="e.g., 123456" pattern="\d{6}" title="6-digit game ID" required>
                                </div>
                                <button type="submit" class="btn" style="background: #007bff; color: white;">‚û°Ô∏è Join Game</button>
                            </form>
                        </div>
                    </div>
                </div>

            {# --- State 3: Waiting to Start (Lobby) --- #}
            {% elif game_state == "waiting_to_start" %}
                <div class="main-content-column" style="text-align: center; max-width: 800px; margin: 0 auto;">
                    <h2>Waiting to Start Game: {{ set_name }}</h2>
                    <p>This is a **{{ set_name }}** game.</p>
                    
                    {# Game ID visibility: Only the creator sees the ID clearly #}
                    {% if is_creator %}
                        <p>Share this **Game ID** with your friends to join:</p>
                        <div style="margin: 10px auto; max-width: 400px; padding: 15px; border: 2px dashed #dc3545; background-color: #fff0f0;">
                            <p style="font-size: 1.5em; font-weight: bold; color: #dc3545;">{{ game_id }}</p>
                        </div>
                    {% else %}
                        {# Non-creators only see the waiting message #}
                        <p style="margin-top: 20px; font-style: italic; font-size: 1.1em;">Waiting for the game creator to start...</p>
                    {% endif %}
                    
                    <div style="margin-top: 30px;">
                        {% if is_creator %}
                            <h3>Players Joined:</h3>
                            <ul id="player-list" style="list-style: none; padding: 0;">
                                {% for player in players.values() %}
                                    <li style="font-size: 1.1em; padding: 5px;">{{ player }} {% if player == current_user.username %} (You) {% endif %}</li>
                                {% endfor %}
                            </ul>
                            <form action="/cards/playwithfriends/{{ game_id }}/start" method="POST" style="margin-top: 30px;">
                                <button type="submit" class="btn" style="background: #28a745; color: white; font-size: 1.2em;">‚ñ∂Ô∏è Start Game Now</button>
                            </form>
                        {% else %}
                             {# Optional: Small hint for players, but no player list #}
                             <p style="font-size: 0.9em; color: #666;">Ask the creator for the Game ID if you need to share it with friends.</p>
                        {% endif %}
                    </div>
                </div>
                
            {# --- State 4: Game Finished --- #}
            {% elif game_state == "finished" %}
                 <div class="main-content-column" style="text-align: center;">
                    <h2>Game Over: {{ set_name }}</h2>
                    <p>The game has concluded! Check the final leaderboard on the right.</p>
                    <div style="margin-top: 30px;">
                        <a href="/cards/playwithfriends" class="btn" style="background: #007bff; color: white;">Return to Game Lobby</a>
                    </div>
                </div>
                <div class="live-chat-sidebar">
                    <div id="leaderboard-view-final" class="leaderboard-history" style="display: block; flex-grow: 1; overflow-y: auto; padding: 10px;">
                        <div style="font-size: 1.2em; text-align: center; padding-bottom: 10px; border-bottom: 1px solid #ddd; margin-bottom: 10px; font-weight: bold;">
                            FINAL LEADERBOARD
                        </div>
                        <ul id="leaderboard-list" class="leaderboard-list" style="list-style: none; padding: 0;">
                            {# Scores will be populated by the dedicated JS below #}
                        </ul>
                    </div>
                </div>
            
            {# --- State 5: Game In Progress (Live Interface) --- #}
            {% elif game_state == "in_progress" %}
                <div class="main-content-column">
                    
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h2>{{ set_name }} Game</h2>
                        {% if is_creator %}
                            <form action="/cards/playwithfriends/{{ game_id }}/end" method="POST" style="display: inline;" onsubmit="return confirm('Are you sure you want to end the game prematurely? This will finalize the scores for all players.');">
                                <button type="submit" class="btn btn-danger" id="endGameBtn">End Game üõë</button>
                            </form>
                        {% endif %}
                    </div>
                    

                    <div class="card-interface">
                        <div id="card-display-area" style="padding: 20px; width: 100%;">
                            <div id="card-content-container" style="font-weight: bold; min-height: 50px;">
                                {% if card %}
                                    <div id="card-front-text">{{ card.front }}</div>
                                    <div id="card-back-text" style="display: none;">{{ card.back }}</div>
                                {% else %}
                                    <div id="card-front-text">Game has started! Waiting for the first question...</div>
                                    <div id="card-back-text" style="display: none;"></div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="button-controls">
                            <button class="btn" id="showAnswerBtn">Answer</button>
                            {% if is_creator %}
                                <button class="btn" id="nextCardBtn">Post Next Question</button>
                            {% endif %}
                        </div>
                    </div>

                </div>

                <div class="live-chat-sidebar">
                    <div class="scoring-header-area">
                        <div class="score-pills-container">
                            <div class="score-pill correct-pill">
                                <span class="pill-label">‚úÖ Correct: <span id="user-score-correct">0.0</span></span>
                                <div id="initials-correct" class="initials-area"></div>
                            </div>
                            <div class="score-pill half-correct-pill">
                                <span class="pill-label">üü° Half-Correct: <span id="user-score-half">0.0</span></span>
                                <div id="initials-half" class="initials-area"></div>
                            </div>
                            <div class="score-pill wrong-pill">
                                <span class="pill-label">‚ùå Wrong: <span id="user-score-wrong">0</span></span>
                                <div id="initials-wrong" class="initials-area"></div>
                            </div>
                        </div>
                    </div>

                    <div class="chat-mode-selector" id="chat-mode-selector">
                        <button id="mode-answer" class="active">Chat Answer</button>
                        <button id="mode-friends">Chat with Friends</button>
                        <button id="mode-leaderboard"> üèÜ Leaderboard</button> 
                    </div>
                    
                    <div id="sidebar-content-wrapper" style="display: flex; flex-direction: column; flex-grow: 1;">
                        
                        <div id="chat-view" style="display: flex; flex-direction: column; flex-grow: 1;">
                            <div class="chat-messages" id="chat-messages-container" style="flex-grow: 1;">
                                <div id="chat-history-answer" class="chat-history active"><ul></ul></div>
                                <div id="chat-history-friends" class="chat-history"><ul></ul></div>
                            </div>
                        </div>

                        <div id="leaderboard-view" class="leaderboard-history" style="display: none; flex-grow: 1; overflow-y: auto; padding: 10px;">
                            <div style="font-size: 1.2em; text-align: center; padding-bottom: 10px; border-bottom: 1px solid #ddd; margin-bottom: 10px; font-weight: bold;">
                                Global Leaderboard
                            </div>
                            <ul id="leaderboard-list" class="leaderboard-list" style="list-style: none; padding: 0;"></ul>
                        </div>
                        
                    </div>
                    
                    <div id="chat-input-wrapper" class="chat-input-wrapper">
                        <div class="chat-input-area">
                            <form id="chat-form" action="">
                                <input type="text" id="messageText" autocomplete="off" placeholder="Type your answer or message..." />
                                <button id="send-button" type="submit">Send</button>
                            </form>
                        </div>
                    </div>
                    
                </div>
            {% endif %}

        {% else %}
            {# Check 1 Else: Not Logged In #}
            <div class="main-content-column">
                <h2>Access Denied (403)</h2>
                <p>You must be logged in to access this page. Please <a href="/users/login">login</a> or <a href="/users/register">register</a>.</p>
            </div>
        {% endif %} 
    </div>
</main>

{# --- JavaScript Section: Only load if game_id exists (WAITING, IN_PROGRESS, FINISHED) --- #}
<script>
    {% if current_user and game_id %}
        const userName = "{{ current_user.username }}";
        const gameId = "{{ game_id }}";
        const isCreator = {{ "true" if is_creator else "false" }};


        // WebSocket connection is needed for WAITING, IN_PROGRESS, and FINISHED states
        const ws = new WebSocket(`ws://{{ request.url.netloc }}/cards/ws/${gameId}/${userName}`);
        
        // Define common helper functions (must be available in all JS scopes)

        // Only define these if we are in an IN_PROGRESS or FINISHED state to avoid DOM errors in WAITING state
        {% if game_state == "in_progress" or game_state == "finished" %}
            const leaderboardList = document.getElementById('leaderboard-list');
            const chatView = document.getElementById('chat-view');
            const leaderboardView = document.getElementById('leaderboard-view');
            const chatInputWrapper = document.getElementById('chat-input-wrapper');
            const modeAnswerBtn = document.getElementById('mode-answer');
            const modeFriendsBtn = document.getElementById('mode-friends');
            const modeLeaderboardBtn = document.getElementById('mode-leaderboard');
            const historyFriends = document.getElementById('chat-history-friends');
            const historyAnswer = document.getElementById('chat-history-answer');
            const messageInput = document.getElementById('messageText');
            
            function renderLeaderboard(scores) {
                if (!leaderboardList) return; 

                leaderboardList.innerHTML = '';
                const sortedScores = Object.entries(scores)
                    .map(([username, data]) => ({ username, grade: data.grade || 0 }))
                    .sort((a, b) => b.grade - a.grade);

                sortedScores.forEach((item, index) => {
                    const li = document.createElement('li');
                    li.style.padding = '8px 0';
                    li.style.borderBottom = '1px dotted #eee';
                    const rank = index + 1;
                    const rankSpan = `<span class="rank" style="font-weight: bold; width: 30px; display: inline-block;">${rank}.</span>`;
                    const nameSpan = `<span style="${item.username === userName ? 'color: #dc3545; font-weight: bold;' : ''}">${item.username}</span>`;
                    const scoreSpan = `<span style="float: right; font-weight: bold;">${item.grade.toFixed(1)} pts</span>`;
                    li.innerHTML = rankSpan + nameSpan + scoreSpan;
                    leaderboardList.appendChild(li);
                });
                
                if ("{{ game_state }}" !== "finished") {
                    setSidebarView('leaderboard'); 
                }
            }
            
            // Only required in IN_PROGRESS state, but must be defined to avoid errors in listeners
            let currentChatMode = 'answer';
            let currentSidebarView = 'chat';
            
            function setSidebarView(view) {
                 if ("{{ game_state }}" !== "in_progress") return;
                 currentSidebarView = view;
                 if (view === 'chat') {
                     chatView.style.display = 'flex';
                     leaderboardView.style.display = 'none';
                     chatInputWrapper.style.display = 'block'; 
                     (currentChatMode === 'answer' ? modeAnswerBtn : modeFriendsBtn).classList.add('active');
                     modeLeaderboardBtn.classList.remove('active');
                 } else if (view === 'leaderboard') {
                     chatView.style.display = 'none';
                     leaderboardView.style.display = 'block';
                     chatInputWrapper.style.display = 'none'; 
                     modeAnswerBtn.classList.remove('active');
                     modeFriendsBtn.classList.remove('active');
                     modeLeaderboardBtn.classList.add('active'); 
                     leaderboardView.scrollTop = 0;
                 }
             }
             
             function appendChatMessage(sender, text, mode) {
                 let historyContainer = (mode === 'answer') ? historyAnswer : historyFriends;
                 let messageList = historyContainer.querySelector('ul');
                 if (!messageList) { messageList = document.createElement('ul'); historyContainer.appendChild(messageList); }
                 const li = document.createElement('li');
                 li.innerHTML = `<span class="username">${sender}:</span> ${text}`;
                 messageList.appendChild(li);
                 if (chatView && chatView.style.display !== 'none' && historyContainer.classList.contains('active')) {
                     historyContainer.scrollTop = historyContainer.scrollHeight;
                 }
             }

        {% endif %}


        // --- Shared WebSocket Listener ---
        ws.onmessage = function(event) {
            let data;
            try {
                data = JSON.parse(event.data);
            } catch (e) {
                console.error("Failed to parse incoming WebSocket message:", event.data, e);
                return;
            }

            // Game State Transition Signals (Force Reload)
            if (data.type === 'game_start_signal' || data.type === 'game_end') {
                window.location.reload(true);
                return;
            }
            
            // --- IN PROGRESS/FINISHED HANDLERS ---
            {% if game_state == "in_progress" or game_state == "finished" %}
                
                if (data.type === 'chat_message') {
                    appendChatMessage(data.sender, data.text, data.mode);
                } else if (data.type === 'score_update') {
                    renderLeaderboard(data.scores);
                    {% if game_state == "in_progress" %}
                        // Only update pills if in progress
                        updateScoreboardPills(data.scores, userName, 'none'); 
                    {% endif %}
                }
                
            {% endif %}
        };
        
        ws.onopen = function() {
            console.log(`WebSocket connected to Game ${gameId} as ${userName}.`);
            ws.send(JSON.stringify({ type: 'score_request' }));
        };

        ws.onclose = function(event) {
            console.log(`WebSocket connection closed for game ${gameId}.`);
        };
        
        // --- IN_PROGRESS SPECIFIC JS (Full Game Logic) ---
        {% if game_state == "in_progress" %}
            
            // Re-access all IN_PROGRESS DOM elements and state variables
            const showAnswerBtn = document.getElementById('showAnswerBtn');
            const cardContentContainer = document.getElementById('card-content-container');
            const cardFrontText = document.getElementById('card-front-text');
            const cardBackText = document.getElementById('card-back-text');
            const cardDisplayArea = document.querySelector('.card-interface');
            const scoreCorrect = document.getElementById('user-score-correct');
            const scoreHalf = document.getElementById('user-score-half');
            const scoreWrong = document.getElementById('user-score-wrong');
            const initialsCorrect = document.getElementById('initials-correct');
            const initialsHalf = document.getElementById('initials-half');
            const initialsWrong = document.getElementById('initials-wrong');
            const chatForm = document.getElementById('chat-form');
            
            let isFlipped = false;
            let hasAnsweredCurrentCard = false; 
            let currentCardData = {
                front: cardFrontText ? cardFrontText.textContent.trim() : '',
                back: cardBackText ? cardBackText.textContent.trim() : ''
            };
            
            if(cardContentContainer) cardContentContainer.style.fontSize = '1.5em';
            
            // Full Helper Definitions (Required in this scope for closure)
            function initializeChatHistory() {
                if (historyAnswer.querySelector('ul').children.length === 0) {
                    appendChatMessage("Grader", "Submit your answers for scoring.", 'answer');
                }
                if (historyFriends.querySelector('ul').children.length === 0) {
                    appendChatMessage("Friends", "Quick chat messages appear here.", 'friends');
                }
            }
            function createInitialsIcon(initials) {
                const icon = document.createElement('span');
                icon.className = 'profile-icon';
                icon.textContent = initials;
                return icon;
            }
            function resetScoreboardInitials() {
                initialsCorrect.innerHTML = '';
                initialsHalf.innerHTML = '';
                initialsWrong.innerHTML = '';
            }
            function updateScoreboardPills(scores, senderUsername, result) {
                 if (result !== 'none' && scores[senderUsername]) {
                    const initials = senderUsername.charAt(0).toUpperCase();
                    let targetDiv;
                    
                    ['correct', 'half', 'wrong'].forEach(r => {
                        const prevDiv = document.getElementById(`initials-${r}`);
                        const prevIcon = prevDiv.querySelector(`[data-username="${senderUsername}"]`);
                        if (prevIcon) { prevDiv.removeChild(prevIcon); }
                    });

                    if (result === 'correct') { targetDiv = initialsCorrect; } 
                    else if (result === 'half') { targetDiv = initialsHalf; } 
                    else { targetDiv = initialsWrong; }
                    
                    const icon = createInitialsIcon(initials);
                    icon.setAttribute('data-username', senderUsername); 
                    targetDiv.appendChild(icon);
                }
                
                const userScore = scores[userName];
                if (userScore) {
                    scoreCorrect.textContent = (userScore.correct * 5).toFixed(1); 
                    scoreHalf.textContent = (userScore.half * 2.5).toFixed(1); 
                    scoreWrong.textContent = userScore.wrong; 
                }
            }
            function setChatMode(mode) {
                 currentChatMode = mode;
                 modeAnswerBtn.classList.remove('active');
                 modeFriendsBtn.classList.remove('active');
                 modeLeaderboardBtn.classList.remove('active');
                 historyAnswer.classList.remove('active');
                 historyFriends.classList.remove('active');
                 if (mode === 'answer') {
                     modeAnswerBtn.classList.add('active');
                     historyAnswer.classList.add('active');
                     messageInput.placeholder = "Type your answer here...";
                     historyAnswer.scrollTop = historyAnswer.scrollHeight;
                 } else { 
                     modeFriendsBtn.classList.add('active');
                     historyFriends.classList.add('active');
                     messageInput.placeholder = "Chat with friends...";
                     historyFriends.scrollTop = historyFriends.scrollHeight;
                 }
                 setSidebarView('chat'); 
             }
            
            // Overwrite ws.onmessage to include IN_PROGRESS specific data handling
            const originalWsOnMessage = ws.onmessage;
            ws.onmessage = function(event) {
                 originalWsOnMessage(event); // Run shared logic first
                 
                 let data;
                 try {
                     data = JSON.parse(event.data);
                 } catch (e) {
                     return;
                 }
                 
                 // Process IN_PROGRESS data types
                 if (data.type === 'new_card') {
                     currentCardData.front = data.front;
                     currentCardData.back = data.back;
                     isFlipped = false;
                     hasAnsweredCurrentCard = false; 
                     cardFrontText.textContent = data.front; 
                     cardBackText.textContent = data.back;
                     cardContentContainer.style.fontSize = '1.5em'; 
                     showAnswerBtn.textContent = 'Answer';
                     messageInput.value = '';
                     resetScoreboardInitials(); 
                     setSidebarView('chat'); 
                     cardDisplayArea.style.backgroundColor = '#f0fff0'; 
                     setTimeout(() => { cardDisplayArea.style.backgroundColor = ''; }, 300);
                 } else if (data.type === 'answer_result') {
                     updateScoreboardPills(data.scores, data.sender, data.result);
                     if (data.sender === userName) {
                         hasAnsweredCurrentCard = true;
                         if (currentChatMode === 'answer') { messageInput.value = ''; }
                     }
                 }
            };
            
            // Event Listeners for IN_PROGRESS
            modeAnswerBtn.addEventListener('click', () => setChatMode('answer'));
            modeFriendsBtn.addEventListener('click', () => setChatMode('friends'));
            modeLeaderboardBtn.addEventListener('click', function() {
                 if (currentSidebarView === 'leaderboard') { setSidebarView('chat'); } 
                 else {
                     setSidebarView('leaderboard'); 
                     ws.send(JSON.stringify({ type: 'score_request', payload: { command: 'leaderboard' } }));
                 }
            });
            showAnswerBtn.addEventListener('click', function() {
                if (!currentCardData.front) { return; }
                if (!isFlipped) {
                    cardFrontText.textContent = currentCardData.back;
                    cardContentContainer.style.fontSize = '1.2em';
                    showAnswerBtn.textContent = 'Back to Question';
                    isFlipped = true;
                } else {
                    cardFrontText.textContent = currentCardData.front;
                    cardContentContainer.style.fontSize = '1.5em';
                    showAnswerBtn.textContent = 'Answer';
                    isFlipped = false;
                }
            });
            document.getElementById('nextCardBtn')?.addEventListener('click', function() {
                const data = { type: "game_control", payload: { command: "request_next_card" } };
                ws.send(JSON.stringify(data));
            });
            chatForm.addEventListener('submit', async function(event) {
                event.preventDefault();
                const message = messageInput.value.trim();
                if (!message || currentSidebarView === 'leaderboard') return;

                if (currentChatMode === 'answer') {
                    if (hasAnsweredCurrentCard) {
                        appendChatMessage("INFO", "You have already submitted an answer for this question.", 'answer');
                        messageInput.value = '';
                        return;
                    }
                    const data = { type: "answer_submission", payload: { answer: message } };
                    ws.send(JSON.stringify(data));
                } else {
                    const data = { type: "chat", payload: { message: message } };
                    ws.send(JSON.stringify(data));
                    messageInput.value = ''; 
                }
            });
            
            // Set initial chat view
            ws.onopen = function() {
                initializeChatHistory();
                setSidebarView('chat');
                ws.send(JSON.stringify({ type: 'score_request' }));
            };
        {% endif %}
    {% endif %}
</script>
{% endblock %}
